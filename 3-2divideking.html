<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë ÎÇòÎàóÏÖà Ïôï! - Ï¥àÎì±ÌïôÍµê 3ÌïôÎÖÑ 2ÌïôÍ∏∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #e0e5ec;
            --primary-color: #4a86e8;
            --green-color: #6abf69;
            --red-color: #ff6e6e;
            --text-color: #555;
            --light-shadow: rgba(255, 255, 255, 0.9);
            --dark-shadow: rgba(163, 177, 198, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Gowun Dodum', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 800px;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px var(--dark-shadow);
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none !important;
        }

        /* --- ÌôîÎ©¥ Í≥µÌÜµ Ïä§ÌÉÄÏùº --- */
        .screen {
            background-color: var(--bg-color);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 8px 8px 15px var(--dark-shadow), -8px -8px 15px var(--light-shadow);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- Î≤ÑÌäº Í≥µÌÜµ Ïä§ÌÉÄÏùº --- */
        .general-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background-color: var(--bg-color);
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
        }
        .general-btn:hover {
            transform: translateY(-2px);
            color: var(--primary-color);
        }
        .general-btn:active {
            box-shadow: inset 3px 3px 7px var(--dark-shadow), inset -3px -3px 7px var(--light-shadow);
            transform: translateY(0);
        }


        /* --- ÏãúÏûë ÌôîÎ©¥ Ïä§ÌÉÄÏùº --- */
        #start-screen .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .chapter-btn {
            padding: 15px 10px;
        }

        .chapter-btn.selected {
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
            color: var(--primary-color);
            font-weight: bold;
        }

        .mode-selection {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .mode-selection label {
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.2s ease-in-out;
        }
        
        .mode-selection input[type="radio"] {
            display: none;
        }

        .mode-selection input[type="radio"]:checked + label {
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
            color: var(--primary-color);
            font-weight: bold;
        }

        .start-btn {
            padding: 15px 50px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.2s ease-in-out;
        }

        .start-btn:hover {
            background: #3a7bd5;
            transform: translateY(-3px);
        }
        
        .start-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
        }

        /* --- Í≤åÏûÑ ÌôîÎ©¥ Ïä§ÌÉÄÏùº --- */
        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        #menu-back-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }


        #progress-container {
            width: 100%;
            height: 10px;
            background-color: rgba(163, 177, 198, 0.3);
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: inset 2px 2px 5px var(--dark-shadow), inset -2px -2px 5px var(--light-shadow);
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--green-color);
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }

        #game-stats {
            display: flex;
            gap: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        #problem-container {
            margin: 30px 0;
            padding: 40px 20px;
            border-radius: 15px;
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
        }
        
        #problem-text {
            font-size: 3.5rem;
            font-weight: bold;
            letter-spacing: 5px;
        }

        #answer-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #numeric-inputs {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .input-group label {
            font-size: 1rem;
        }

        .answer-input {
            width: 100px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            background-color: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-shadow);
            color: var(--text-color);
        }

        .answer-input:focus {
            outline: none;
            box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-shadow), 0 0 0 2px var(--primary-color);
        }

        #check-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            background: var(--green-color);
            color: white;
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.2s ease-in-out;
        }
        #check-btn:hover {
            transform: translateY(-2px);
        }

        #feedback-area {
            min-height: 40px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        #feedback {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        #show-answer-btn {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            font-size: 1.1rem;
        }

        .feedback-correct { color: var(--green-color); animation: bounce 0.5s; }
        .feedback-wrong { color: var(--red-color); animation: shake 0.5s; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);}
            20%, 40%, 60%, 80% {transform: translateX(5px);}
        }
        
        .boolean-question button {
            padding: 15px 30px;
            font-size: 1.5rem;
            margin: 0 10px;
        }

        /* --- Í≤∞Í≥º ÌôîÎ©¥ Ïä§ÌÉÄÏùº --- */
        #results-message {
            font-size: 2rem;
            margin-bottom: 25px;
            color: var(--primary-color);
        }

        #results-details {
            font-size: 1.5rem;
            margin-bottom: 35px;
            line-height: 1.6;
        }

        #final-corrections {
            font-size: 1.1rem;
            color: #888;
            margin-top: -10px;
        }
        
        .result-btn-group {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            #problem-text { font-size: 2.8rem; }
            .screen { padding: 20px; }
            #game-header { flex-direction: column; gap: 10px; }
            #game-stats { order: 3; }
            #menu-back-btn { order: 1; margin-bottom: 10px; }
            #chapter-title { order: 2; width: 100%; }
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>üëë ÎÇòÎàóÏÖà Ïôï üëë</h1>
        
        <div id="start-screen" class="screen">
            <h2>ÎèÑÏ†ÑÌï† Ï±ïÌÑ∞Î•º Í≥®ÎùºÏ£ºÏÑ∏Ïöî!</h2>
            <div class="chapter-grid">
                <button class="chapter-btn general-btn" data-chapter="1">1. ÎÇ¥Î¶º ÏóÜÎäî (Î™áÏã≠)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="2">2. ÎÇ¥Î¶º ÏóÜÎäî (Î™áÏã≠Î™á)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="3">3. ÎÇ¥Î¶º ÏûàÎäî (Î™áÏã≠)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="4">4. ÎÇ¥Î¶º ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="5">5. ÎÇ¥Î¶º ÏóÜÍ≥† ÎÇòÎ®∏ÏßÄ ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="6">6. ÎÇ¥Î¶º ÏûàÍ≥† ÎÇòÎ®∏ÏßÄ ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)</button>
                <button class="chapter-btn general-btn" data-chapter="7">7. ÎÇòÎ®∏ÏßÄÍ∞Ä ÏûàÎäî ÎÇòÎàóÏÖà Í≥ÑÏÇ∞ ÌôïÏù∏ÌïòÍ∏∞</button>
                <button class="chapter-btn general-btn" data-chapter="8">8. (ÏÑ∏ ÏûêÎ¶¨ Ïàò)√∑(Ìïú ÏûêÎ¶¨ Ïàò)</button>
                <button class="chapter-btn general-btn" data-chapter="9">9. ÎÇòÎ®∏ÏßÄÍ∞Ä ÏûàÎäî (ÏÑ∏ ÏûêÎ¶¨ Ïàò)√∑(Ìïú ÏûêÎ¶¨ Ïàò)</button>
            </div>
            <h2>Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</h2>
            <div class="mode-selection">
                <input type="radio" id="practice-mode" name="mode" value="practice" checked>
                <label for="practice-mode">üéì Ïó∞Ïäµ Î™®Îìú</label>
                <input type="radio" id="challenge-mode" name="mode" value="challenge">
                <label for="challenge-mode">üèÜ ÎèÑÏ†Ñ Î™®Îìú</label>
            </div>
            <button id="start-btn" class="start-btn" disabled>ÏãúÏûëÌïòÍ∏∞!</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div id="game-header">
                <h2 id="chapter-title"></h2>
                <div id="game-stats">
                    <span id="score">Ï†êÏàò: 0</span>
                    <span id="timer" class="hidden">ÏãúÍ∞Ñ: 120</span>
                </div>
                <button id="menu-back-btn" class="general-btn">üè† Î©îÎâ¥Î°ú</button>
            </div>
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
            <div id="problem-container">
                <div id="problem-text"></div>
            </div>
            <form id="answer-form">
                <div id="numeric-inputs">
                    <div class="input-group">
                        <label for="quotient">Î™´:</label>
                        <input type="number" id="quotient" class="answer-input" autocomplete="off" inputmode="numeric">
                    </div>
                    <div class="input-group" id="remainder-group">
                        <label for="remainder">ÎÇòÎ®∏ÏßÄ:</label>
                        <input type="number" id="remainder" class="answer-input" autocomplete="off" inputmode="numeric">
                    </div>
                </div>
                <div id="boolean-question" class="hidden">
                    <button type="button" class="boolean-btn general-btn" data-answer="true">‚≠ï ÎßûÏïÑÏöî</button>
                    <button type="button" class="boolean-btn general-btn" data-answer="false">‚ùå ÌãÄÎ†§Ïöî</button>
                </div>
                <div id="feedback-area">
                    <div id="feedback"></div>
                    <button type="button" id="show-answer-btn" class="general-btn hidden">Ï†ïÎãµ Î≥¥Í∏∞</button>
                </div>
                <button id="check-btn">ÌôïÏù∏</button>
            </form>
        </div>

        <div id="results-screen" class="screen hidden">
            <h2 id="results-message">Ï∞∏ ÏûòÌñàÏñ¥Ïöî!</h2>
            <div id="results-details">
                <p>Ï¥ù 10Î¨∏Ï†ú Ï§ë <span id="final-score"></span>Î¨∏Ï†úÎ•º ÎßûÌòîÏñ¥Ïöî!</p>
                <p id="final-corrections" class="hidden"></p> <!-- ÏàòÏ†ïÌï¥ÏÑú ÎßûÌûå Í∞úÏàò ÌëúÏãú ÏòÅÏó≠ -->
                <p id="final-time"></p>
            </div>
            <div class="result-btn-group">
                <button id="restart-btn" class="general-btn">Í∞ôÏùÄ Ï±ïÌÑ∞ Îã§Ïãú ÎèÑÏ†Ñ</button>
                <button id="main-menu-btn" class="general-btn">Ï≤òÏùåÏúºÎ°ú</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ÏöîÏÜå ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultsScreen = document.getElementById('results-screen');
    const chapterBtns = document.querySelectorAll('.chapter-btn');
    const startBtn = document.getElementById('start-btn');
    const chapterTitle = document.getElementById('chapter-title');
    const scoreDisplay = document.getElementById('score');
    const timerDisplay = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const problemText = document.getElementById('problem-text');
    const answerForm = document.getElementById('answer-form');
    const numericInputs = document.getElementById('numeric-inputs');
    const quotientInput = document.getElementById('quotient');
    const remainderGroup = document.getElementById('remainder-group');
    const remainderInput = document.getElementById('remainder');
    const booleanQuestion = document.getElementById('boolean-question');
    const checkBtn = document.getElementById('check-btn');
    const feedback = document.getElementById('feedback');
    const menuBackBtn = document.getElementById('menu-back-btn');
    const showAnswerBtn = document.getElementById('show-answer-btn');
    const finalScore = document.getElementById('final-score');
    const finalCorrections = document.getElementById('final-corrections'); // Ï∂îÍ∞Ä
    const finalTime = document.getElementById('final-time');
    const restartBtn = document.getElementById('restart-btn');
    const mainMenuBtn = document.getElementById('main-menu-btn');

    // --- Í≤åÏûÑ ÏÉÅÌÉú Î≥ÄÏàò ---
    let state = {
        chapter: null,
        mode: 'practice',
        questions: [],
        currentQuestionIndex: 0,
        score: 0,
        timer: 120,
        timerId: null,
        totalQuestions: 10,
        correctedCount: 0, // Ï∂îÍ∞Ä: ÏàòÏ†ïÌï¥ÏÑú ÎßûÌûå Î¨∏Ï†ú Ïàò
        isRetry: false      // Ï∂îÍ∞Ä: ÌòÑÏû¨ Î¨∏Ï†úÍ∞Ä Ïû¨ÏãúÎèÑÏù∏ÏßÄ Ïó¨Î∂Ä
    };
    
    const chapterNames = [
        "1. ÎÇ¥Î¶º ÏóÜÎäî (Î™áÏã≠)√∑(Î™á)", "2. ÎÇ¥Î¶º ÏóÜÎäî (Î™áÏã≠Î™á)√∑(Î™á)",
        "3. ÎÇ¥Î¶º ÏûàÎäî (Î™áÏã≠)√∑(Î™á)", "4. ÎÇ¥Î¶º ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)",
        "5. ÎÇ¥Î¶º ÏóÜÍ≥† ÎÇòÎ®∏ÏßÄ ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)", "6. ÎÇ¥Î¶º ÏûàÍ≥† ÎÇòÎ®∏ÏßÄ ÏûàÎäî (Î™áÏã≠Î™á)√∑(Î™á)",
        "7. ÎÇòÎ®∏ÏßÄÍ∞Ä ÏûàÎäî ÎÇòÎàóÏÖà Í≥ÑÏÇ∞ ÌôïÏù∏ÌïòÍ∏∞", "8. (ÏÑ∏ ÏûêÎ¶¨ Ïàò)√∑(Ìïú ÏûêÎ¶¨ Ïàò)",
        "9. ÎÇòÎ®∏ÏßÄÍ∞Ä ÏûàÎäî (ÏÑ∏ ÏûêÎ¶¨ Ïàò)√∑(Ìïú ÏûêÎ¶¨ Ïàò)"
    ];

    // --- Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---
    chapterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            chapterBtns.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.chapter = parseInt(btn.dataset.chapter);
            startBtn.disabled = false;
        });
    });

    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('click', () => { state.mode = radio.value; });
    });
    
    startBtn.addEventListener('click', startGame);
    
    menuBackBtn.addEventListener('click', () => {
        if (confirm("ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Í≤åÏûÑÏù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. Î©îÏù∏ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†Ïñ¥Ïöî?")) {
            resetToMainMenu();
        }
    });

    checkBtn.addEventListener('click', handleAnswer);
    answerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        handleAnswer();
    });
    
    showAnswerBtn.addEventListener('click', showCorrectAnswerAndMoveNext);

    document.querySelectorAll('.boolean-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            handleBooleanAnswer(e.target.dataset.answer === 'true');
        });
    });

    restartBtn.addEventListener('click', () => {
        resultsScreen.classList.add('hidden');
        startGame();
    });
    mainMenuBtn.addEventListener('click', () => {
        resultsScreen.classList.add('hidden');
        resetToMainMenu();
    });

    // --- ÌïµÏã¨ Ìï®Ïàò ---
    
    function startGame() {
        if (state.timerId) clearInterval(state.timerId);

        state.currentQuestionIndex = 0;
        state.score = 0;
        state.timer = 120;
        state.correctedCount = 0; // Ï¥àÍ∏∞Ìôî
        state.isRetry = false;     // Ï¥àÍ∏∞Ìôî

        state.questions = generateQuestions(state.chapter, state.totalQuestions);
        
        startScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        
        chapterTitle.textContent = chapterNames[state.chapter - 1];
        scoreDisplay.textContent = `Ï†êÏàò: 0`;

        if (state.mode === 'challenge') {
            timerDisplay.classList.remove('hidden');
            startTimer();
        } else {
            timerDisplay.classList.add('hidden');
        }
        
        showAnswerBtn.classList.add('hidden');
        displayQuestion();
    }

    function displayQuestion() {
        if (state.currentQuestionIndex >= state.totalQuestions) {
            endGame();
            return;
        }

        state.isRetry = false; // ÏÉà Î¨∏Ï†úÏù¥ÎØÄÎ°ú Ïû¨ÏãúÎèÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        const q = state.questions[state.currentQuestionIndex];
        problemText.innerHTML = q.text;
        
        feedback.textContent = '';
        feedback.className = '';
        showAnswerBtn.classList.add('hidden');
        checkBtn.textContent = 'ÌôïÏù∏';
        checkBtn.disabled = false;
        
        quotientInput.value = '';
        remainderInput.value = '';

        if (state.chapter === 7) {
            numericInputs.classList.add('hidden');
            booleanQuestion.classList.remove('hidden');
            checkBtn.classList.add('hidden');
        } else {
            numericInputs.classList.remove('hidden');
            booleanQuestion.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            
            const hasRemainder = q.remainder !== 0 || (state.chapter >= 5 && state.chapter !== 8);
            remainderGroup.classList.toggle('hidden', !hasRemainder);
            quotientInput.focus();
        }
        updateProgress();
    }
    
    function handleAnswer() {
        const currentQ = state.questions[state.currentQuestionIndex];
        const userQuotient = parseInt(quotientInput.value);
        const userRemainder = remainderGroup.classList.contains('hidden') ? 0 : (parseInt(remainderInput.value) || 0);

        if (isNaN(userQuotient)) {
            feedback.textContent = 'Î™´ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!';
            feedback.className = 'feedback-wrong';
            setTimeout(() => { feedback.textContent = ''; feedback.className = ''; }, 1000);
            return;
        }

        const isCorrect = userQuotient === currentQ.quotient && userRemainder === currentQ.remainder;
        processAnswer(isCorrect);
    }
    
    function handleBooleanAnswer(userAnswer) {
        const isCorrect = userAnswer === state.questions[state.currentQuestionIndex].isEquationCorrect;
        processAnswer(isCorrect);
        document.querySelectorAll('.boolean-btn').forEach(btn => btn.disabled = true);
    }
    
    function showCorrectAnswerAndMoveNext() {
        const q = state.questions[state.currentQuestionIndex];
        showAnswerBtn.classList.add('hidden');
        
        let answerText = `Ï†ïÎãµ: Î™´ ${q.quotient}`;
        if (!remainderGroup.classList.contains('hidden') || q.remainder > 0) {
            answerText += `, ÎÇòÎ®∏ÏßÄ ${q.remainder}`;
        }
        feedback.textContent = "‚úî " + answerText;
        feedback.className = 'feedback-correct';
        checkBtn.disabled = true;

        setTimeout(() => {
            state.currentQuestionIndex++;
            displayQuestion();
        }, 2000);
    }

    function processAnswer(isCorrect) {
        if (isCorrect) {
            feedback.textContent = 'Îî©ÎèôÎåï! Ï†ïÎãµÏù¥ÏóêÏöî! üéâ';
            feedback.className = 'feedback-correct';
            state.score++;

            if (state.isRetry) { // Ïû¨ÏãúÎèÑÌï¥ÏÑú ÎßûÌòîÎã§Î©¥
                state.correctedCount++;
            }

            checkBtn.disabled = true;
            showAnswerBtn.classList.add('hidden');

            setTimeout(() => {
                state.currentQuestionIndex++;
                displayQuestion();
                document.querySelectorAll('.boolean-btn').forEach(btn => btn.disabled = false);
            }, 1500);

        } else { // Ïò§ÎãµÏùº Í≤ΩÏö∞
            feedback.className = 'feedback-wrong';
            
            if (state.mode === 'practice') {
                state.isRetry = true; // Ïû¨ÏãúÎèÑ ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                checkBtn.disabled = false; // Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                checkBtn.textContent = 'Îã§Ïãú ÌôïÏù∏';
                feedback.textContent = 'ÏïÑÏâΩÎÑ§Ïöî, Îã§Ïãú ÌïúÎ≤à ÌíÄÏñ¥Î≥ºÍπåÏöî? ü§î';
                showAnswerBtn.classList.remove('hidden'); // Ï†ïÎãµ Î≥¥Í∏∞(Ìè¨Í∏∞) Î≤ÑÌäº ÌëúÏãú
            } else { // ÎèÑÏ†Ñ Î™®Îìú
                feedback.textContent = 'Ïò§ÎãµÏûÖÎãàÎã§! üò•';
                checkBtn.disabled = true;
                setTimeout(() => {
                    state.currentQuestionIndex++;
                    displayQuestion();
                    document.querySelectorAll('.boolean-btn').forEach(btn => btn.disabled = false);
                }, 1500);
            }
        }
        scoreDisplay.textContent = `Ï†êÏàò: ${state.score}`;
    }

    function updateProgress() {
        const progress = (state.currentQuestionIndex / state.totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
    }

    function startTimer() {
        timerDisplay.textContent = `ÏãúÍ∞Ñ: ${state.timer}`;
        state.timerId = setInterval(() => {
            state.timer--;
            timerDisplay.textContent = `ÏãúÍ∞Ñ: ${state.timer}`;
            if (state.timer <= 0) {
                clearInterval(state.timerId);
                endGame();
            }
        }, 1000);
    }

    function endGame() {
        if (state.timerId) clearInterval(state.timerId);
        
        gameScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');

        finalScore.textContent = state.score;
        
        if (state.score === state.totalQuestions) {
            resultsMessage.textContent = 'üéâ ÏôÑÎ≤ΩÌï¥Ïöî! ÎãπÏã†Ïù¥ Î∞îÎ°ú ÎÇòÎàóÏÖà Ïôï! üëë';
        } else if (state.score >= state.totalQuestions * 0.7) {
            resultsMessage.textContent = 'üëç Ï†ïÎßê ÏûòÌñàÏñ¥Ïöî! Ï°∞Í∏àÎßå Îçî ÌûòÎÇ¥Ïöî!';
        } else {
            resultsMessage.textContent = 'ü§î ÏïÑÏâ¨ÏõåÏöî! Ïó∞ÏäµÌïòÎ©¥ Îçî ÏûòÌï† Ïàò ÏûàÏñ¥Ïöî.';
        }
        
        // Îã§Ïãú ÌíÄÏñ¥ ÎßûÌûå Í∞úÏàò ÌëúÏãú
        if (state.correctedCount > 0) {
            finalCorrections.textContent = `(Ïù¥ Ï§ë ${state.correctedCount}Í∞úÎäî Îã§Ïãú ÌíÄÏñ¥ ÎßûÌòîÏñ¥Ïöî!)`;
            finalCorrections.classList.remove('hidden');
        } else {
            finalCorrections.classList.add('hidden');
        }

        if (state.mode === 'challenge') {
            const timeTaken = 120 - state.timer;
            finalTime.textContent = `Í±∏Î¶∞ ÏãúÍ∞Ñ: ${timeTaken}Ï¥à`;
            finalTime.classList.remove('hidden');
        } else {
            finalTime.classList.add('hidden');
        }
    }

    function resetToMainMenu() {
        if (state.timerId) clearInterval(state.timerId);
        gameScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        state.chapter = null;
        startBtn.disabled = true;
        chapterBtns.forEach(b => b.classList.remove('selected'));
    }

    // --- Î¨∏Ï†ú ÏÉùÏÑ± Î°úÏßÅ (Ïû¨Í∑Ä Ï†úÍ±∞ Î∞è ÏïàÏ†ÑÏÑ± Í∞ïÌôî) ---
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    
    function generateQuestions(chapter, count) {
        const questions = new Set();
        const maxAttempts = count * 100; // ÏµúÎåÄ ÏãúÎèÑ ÌöüÏàò Ï†úÌïú
        let attempts = 0;
        
        while (questions.size < count && attempts < maxAttempts) {
            attempts++;
            let q;
            switch(chapter) {
                case 1: q = genCh1(); break; 
                case 2: q = genCh2(); break;
                case 3: q = genCh3(); break; 
                case 4: q = genCh4(); break;
                case 5: q = genCh5(); break; 
                case 6: q = genCh6(); break;
                case 7: q = genCh7(); break; 
                case 8: q = genCh8(); break;
                case 9: q = genCh9(); break;
            }
            if (q) {
                questions.add(JSON.stringify(q));
            }
        }
        
        // Ï∂©Î∂ÑÌïú Î¨∏Ï†úÍ∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Ï§ëÎ≥µÏùÑ ÌóàÏö©
        const result = Array.from(questions).map(q => JSON.parse(q));
        while (result.length < count) {
            result.push(result[result.length % result.length]);
        }
        
        return result;
    }
    
    function genCh1() {
        const divisor = randInt(2, 4);
        const quotient = 10 * randInt(1, 4);
        const dividend = divisor * quotient;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: 0
        };
    }
    
    function genCh2() {
        const divisor = randInt(2, 4);
        const quotient = 10 * randInt(1, 4) + randInt(1, Math.floor(9 / divisor));
        const dividend = divisor * quotient;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: 0
        };
    }
    
    function genCh3() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(3, 8);
            const quotient = randInt(11, 30);
            const dividend = divisor * quotient;
            
            // Ïã≠Ïùò ÏûêÎ¶¨Í∞Ä ÎÇòÎàÑÎäî ÏàòÎ°ú ÎÇòÎàÑÏñ¥Îñ®Ïñ¥ÏßÄÏßÄ ÏïäÍ≥†, ÏùºÏùò ÏûêÎ¶¨Îäî 0
            if (Math.floor(dividend / 10) % divisor !== 0 && dividend % 10 === 0) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: 0
                };
            }
        }
        // Ïã§Ìå® Ïãú Ï°∞Í±¥ ÏôÑÌôî
        const divisor = randInt(3, 8);
        const quotient = randInt(11, 30);
        const dividend = divisor * quotient;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: 0
        };
    }
    
    function genCh4() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(3, 8);
            const quotient = randInt(11, 30);
            const dividend = divisor * quotient;
            
            // Ïã≠Ïùò ÏûêÎ¶¨Í∞Ä ÎÇòÎàÑÎäî ÏàòÎ°ú ÎÇòÎàÑÏñ¥Îñ®Ïñ¥ÏßÄÏßÄ ÏïäÍ≥†, ÏùºÏùò ÏûêÎ¶¨ÎèÑ 0Ïù¥ ÏïÑÎãò
            if (Math.floor(dividend / 10) % divisor !== 0 && dividend % 10 !== 0) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: 0
                };
            }
        }
        // Ïã§Ìå® Ïãú Ï°∞Í±¥ ÏôÑÌôî
        const divisor = randInt(3, 8);
        const quotient = randInt(11, 30);
        const dividend = divisor * quotient;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: 0
        };
    }
    
    function genCh5() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(2, 4);
            const quotient = 10 * randInt(1, 4) + randInt(0, Math.floor(9 / divisor));
            const remainder = randInt(1, divisor - 1);
            const dividend = divisor * quotient + remainder;
            
            // Ïã≠Ïùò ÏûêÎ¶¨Í∞Ä ÎÇòÎàÑÎäî ÏàòÎ°ú ÎÇòÎàÑÏñ¥Îñ®Ïñ¥Ïßê
            if (Math.floor(dividend / 10) % divisor === 0) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: remainder
                };
            }
        }
        // Ïã§Ìå® Ïãú Ï°∞Í±¥ ÏôÑÌôî
        const divisor = randInt(2, 4);
        const quotient = 10 * randInt(1, 4) + randInt(0, Math.floor(9 / divisor));
        const remainder = randInt(1, divisor - 1);
        const dividend = divisor * quotient + remainder;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: remainder
        };
    }
    
    function genCh6() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(3, 8);
            const quotient = randInt(11, 30);
            const remainder = randInt(1, divisor - 1);
            const dividend = divisor * quotient + remainder;
            
            // Ïã≠Ïùò ÏûêÎ¶¨Í∞Ä ÎÇòÎàÑÎäî ÏàòÎ°ú ÎÇòÎàÑÏñ¥Îñ®Ïñ¥ÏßÄÏßÄ ÏïäÏùå
            if (Math.floor(dividend / 10) % divisor !== 0) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: remainder
                };
            }
        }
        // Ïã§Ìå® Ïãú Ï°∞Í±¥ ÏôÑÌôî
        const divisor = randInt(3, 8);
        const quotient = randInt(11, 30);
        const remainder = randInt(1, divisor - 1);
        const dividend = divisor * quotient + remainder;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: remainder
        };
    }
    
    function genCh7() {
        const divisor = randInt(3, 9);
        const quotient = randInt(5, 20);
        const remainder = randInt(0, divisor - 1);
        const dividend = divisor * quotient + remainder;
        const isCorrect = Math.random() > 0.4;
        
        let displayQuotient = quotient;
        let displayRemainder = remainder;
        
        if (!isCorrect) {
            if (Math.random() > 0.5) {
                // Î™´ ÌãÄÎ¶¨Í≤å
                displayQuotient += randInt(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                if (displayQuotient < 0) displayQuotient = 0;
            } else {
                // ÎÇòÎ®∏ÏßÄ ÌãÄÎ¶¨Í≤å (ÏµúÎåÄ 20Î≤à ÏãúÎèÑ)
                let attempts = 0;
                while (displayRemainder === remainder && attempts < 20) {
                    attempts++;
                    displayRemainder = remainder === 0 ? randInt(1, divisor - 1) : 
                                      (Math.random() > 0.5 ? 0 : randInt(0, divisor));
                }
            }
        }
        
        let remainderText = displayRemainder > 0 ? `... ${displayRemainder}` : "";
        return {
            text: `${dividend} &div; ${divisor} = ${displayQuotient} ${remainderText}`,
            isEquationCorrect: isCorrect
        };
    }
    
    function genCh8() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(2, 9);
            const quotient = randInt(101, 300);
            const dividend = divisor * quotient;
            
            if (dividend <= 999) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: 0
                };
            }
        }
        // Ïã§Ìå® Ïãú Î≤îÏúÑ Ï°∞Ï†ï
        const divisor = randInt(2, 9);
        const quotient = randInt(101, Math.floor(999 / divisor));
        const dividend = divisor * quotient;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: 0
        };
    }
    
    function genCh9() {
        const maxAttempts = 1000;
        for (let i = 0; i < maxAttempts; i++) {
            const divisor = randInt(2, 9);
            const quotient = randInt(101, 300);
            const remainder = randInt(1, divisor - 1);
            const dividend = divisor * quotient + remainder;
            
            if (dividend <= 999) {
                return {
                    text: `${dividend} &div; ${divisor}`,
                    dividend: dividend,
                    divisor: divisor,
                    quotient: quotient,
                    remainder: remainder
                };
            }
        }
        // Ïã§Ìå® Ïãú Î≤îÏúÑ Ï°∞Ï†ï
        const divisor = randInt(2, 9);
        const quotient = randInt(101, Math.floor(999 / divisor));
        const remainder = randInt(1, divisor - 1);
        const dividend = divisor * quotient + remainder;
        return {
            text: `${dividend} &div; ${divisor}`,
            dividend: dividend,
            divisor: divisor,
            quotient: quotient,
            remainder: remainder
        };
    }
});
</script>

</body>
</html>
