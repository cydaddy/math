<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초등 3학년 2학기 곱셈 연산왕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 공책 느낌의 그리드 배경 */
        body {
            background-color: #f0f9ff; /* bg-sky-50 */
            background-image:
                linear-gradient(rgba(17, 94, 89, 0.1) 1px, transparent 1px),
                linear-gradient(to right, rgba(17, 94, 89, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
        }

        /* 숫자 입력창 위아래 화살표(스피너) 제거 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 애니메이션 효과 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
            80% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .shake { animation: shake 0.3s ease-in-out forwards; }
        
        /* 축하 폭죽 애니메이션 */
        #fireworks-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        .firework {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #fff;
            animation: shoot 2s ease-out forwards;
        }
        @keyframes shoot {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-90vh); opacity: 0; }
        }
        .firework::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0;
            animation: explode 1s ease-out forwards;
            animation-delay: 2s;
        }
        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        .firework:nth-child(5n+1)::before { box-shadow: 0 0 15px 5px #ff4757, 0 0 25px 15px #ff6b81; }
        .firework:nth-child(5n+2)::before { box-shadow: 0 0 15px 5px #5352ed, 0 0 25px 15px #5352ed; }
        .firework:nth-child(5n+3)::before { box-shadow: 0 0 15px 5px #2ed573, 0 0 25px 15px #2ed573; }
        .firework:nth-child(5n+4)::before { box-shadow: 0 0 15px 5px #ffa502, 0 0 25px 15px #ffa502; }
        .firework:nth-child(5n+5)::before { box-shadow: 0 0 15px 5px #f78fb3, 0 0 25px 15px #f78fb3; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center font-sans p-4">
    <div id="app" class="container mx-auto max-w-4xl text-center">

        <!-- 타이틀 -->
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-teal-700 whitespace-nowrap">🎉 초등 3학년 2학기 곱셈 연산왕 🎉</h1>
            <p class="text-gray-600 mt-2">차근차근 단계를 완료하고 곱셈의 왕이 되어보세요!</p>
        </header>

        <!-- [변경됨] 단계 선택: Flexbox를 사용하여 가운데 정렬 -->
        <section id="stage-selection" class="flex flex-wrap justify-center gap-4 mb-8">
            <!-- 자바스크립트로 단계 버튼 생성 -->
        </section>

        <!-- 문제 풀이 영역 -->
        <main id="quiz-area" class="bg-white/80 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-2xl mx-auto" style="display: none;">
            <h2 id="stage-title" class="text-xl sm:text-2xl font-bold text-blue-600 mb-2"></h2>
            <p id="progress-text" class="text-gray-500 mb-6">문제 1 / 5</p>
            
            <div id="problem-display" class="text-6xl font-mono font-bold text-gray-800 my-8 flex justify-center items-center space-x-4">
                <span id="num1"></span><span>×</span><span id="num2"></span>
            </div>

            <input type="number" id="answer-input" class="w-full max-w-xs mx-auto text-3xl p-3 border-4 border-yellow-400 rounded-lg text-center focus:outline-none focus:ring-4 focus:ring-yellow-300 transition" placeholder="정답은?">
            
            <button id="submit-btn" class="mt-6 w-full max-w-xs mx-auto bg-green-500 hover:bg-green-600 text-white font-bold text-2xl py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition">확인</button>
            
            <div id="feedback" class="mt-4 text-xl sm:text-2xl font-bold h-8"></div>
        </main>

        <!-- 최종 축하 화면 -->
        <div id="final-celebration" class="hidden">
            <div id="fireworks-container"></div>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl pop-in">
                <h2 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500 mb-4">👑 최고! 👑</h2>
                <p class="text-3xl font-bold text-gray-800 mb-8">당신은 최고의 곱셈 연산왕입니다!</p>
                <p class="text-lg text-gray-600">모든 문제를 해결한 당신이 정말 자랑스러워요!</p>
                <button onclick="location.reload()" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl">처음부터 다시 도전!</button>
            </div>
        </div>
    </div>

    <script>
        const appState = { currentStage: -1, unlockedStage: 0, currentProblemIndex: 0, problemsPerStage: 5, currentAnswer: 0 };
        const stages = [
            { name: "1단계: 올림 없는 (세 자리 수) × (한 자리 수)", generator: generateNoCarry3x1 },
            { name: "2단계: 올림 한 번 있는 (세 자리 수) × (한 자리 수)", generator: generateOneCarry3x1 },
            { name: "3단계: 올림 여러 번 있는 (세 자리 수) × (한 자리 수)", generator: generateMultiCarry3x1 },
            { name: "4단계: (한 자리 수/두 자리 수) × (몇십)", generator: generateTensMultiply },
            { name: "5단계: (한 자리 수) × (몇십몇)", generator: generate1x2 },
            { name: "6단계: 올림 한 번 있는 (두 자리 수) × (두 자리 수)", generator: generateOneCarry2x2 },
            { name: "7단계: 올림 여러 번 있는 (두 자리 수) × (두 자리 수)", generator: generateMultiCarry2x2 },
        ];

        const stageSelectionEl = document.getElementById('stage-selection');
        const quizAreaEl = document.getElementById('quiz-area');
        const stageTitleEl = document.getElementById('stage-title');
        const progressTextEl = document.getElementById('progress-text');
        const num1El = document.getElementById('num1');
        const num2El = document.getElementById('num2');
        const answerInputEl = document.getElementById('answer-input');
        const submitBtnEl = document.getElementById('submit-btn');
        const feedbackEl = document.getElementById('feedback');
        const finalCelebrationEl = document.getElementById('final-celebration');
        const fireworksContainerEl = document.getElementById('fireworks-container');

        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function countCarries(num, multiplier) { let carries = 0, carry = 0; let tempNum = num; while (tempNum > 0) { const digit = tempNum % 10; if (digit * multiplier + carry >= 10) { carries++; } carry = Math.floor((digit * multiplier + carry) / 10); tempNum = Math.floor(tempNum / 10); } return carries; }
        function generateNoCarry3x1() { let num1, num2; do { num1 = getRandomInt(111, 444); num2 = getRandomInt(2, 4); } while (String(num1).includes('0') || String(num1).split('').some(d => parseInt(d) * num2 >= 10)); return [num1, num2]; }
        function generateOneCarry3x1() { let num1, num2; do { num1 = getRandomInt(100, 999); num2 = getRandomInt(2, 9); } while (countCarries(num1, num2) !== 1); return [num1, num2]; }
        function generateMultiCarry3x1() { let num1, num2; do { num1 = getRandomInt(100, 999); num2 = getRandomInt(2, 9); } while (countCarries(num1, num2) < 2); return [num1, num2]; }
        function generateTensMultiply() { const isTwoDigit = Math.random() > 0.5; const num1 = isTwoDigit ? getRandomInt(10, 99) : getRandomInt(2, 9); const num2 = getRandomInt(1, 9) * 10; return [num1, num2]; }
        function generate1x2() { return [getRandomInt(2, 9), getRandomInt(11, 99)]; }
        function countCarries2x2(num1, num2) { const n2d1 = num2 % 10, n2d2 = Math.floor(num2 / 10); let carries = 0, carry1 = 0, tempNum = num1; while(tempNum > 0) { const digit = tempNum % 10; if(digit * n2d1 + carry1 >= 10) carries++; carry1 = Math.floor((digit * n2d1 + carry1) / 10); tempNum = Math.floor(tempNum/10); } let carry2 = 0; tempNum = num1; while(tempNum > 0) { const digit = tempNum % 10; if(digit * n2d2 + carry2 >= 10) carries++; carry2 = Math.floor((digit * n2d2 + carry2) / 10); tempNum = Math.floor(tempNum/10); } return carries; }
        function generateOneCarry2x2() { let num1, num2; do { num1 = getRandomInt(11, 99); num2 = getRandomInt(11, 99); } while (countCarries2x2(num1, num2) !== 1); return [num1, num2]; }
        function generateMultiCarry2x2() { let num1, num2; do { num1 = getRandomInt(11, 99); num2 = getRandomInt(11, 99); } while (countCarries2x2(num1, num2) < 2); return [num1, num2]; }

        function renderStageButtons() {
            stageSelectionEl.innerHTML = '';
            stages.forEach((stage, index) => {
                const button = document.createElement('button');
                button.dataset.stage = index;
                // [변경됨] 버튼에 고정 너비를 추가하여 flexbox 레이아웃에서 일관된 모양을 유지
                button.className = "p-4 rounded-lg font-bold text-white transition transform hover:scale-105 shadow-md flex flex-col items-center justify-center h-32 w-40";
                const statusSpan = document.createElement('span');
                statusSpan.className = "text-xl mb-1";
                const textSpan = document.createElement('span');
                textSpan.className = "text-sm"; textSpan.textContent = stage.name;
                if (index < appState.unlockedStage) { button.classList.add('bg-green-500'); statusSpan.textContent = '✅ 성공!'; button.onclick = () => startStage(index); }
                else if (index === appState.unlockedStage) { button.classList.add('bg-blue-500', 'animate-pulse'); statusSpan.textContent = '▶️ 도전!'; button.onclick = () => startStage(index); }
                else { button.classList.add('bg-gray-400', 'cursor-not-allowed'); statusSpan.textContent = '🔒 잠김'; }
                button.appendChild(statusSpan); button.appendChild(textSpan); stageSelectionEl.appendChild(button);
            });
        }
        function newProblem() { const [num1, num2] = stages[appState.currentStage].generator(); appState.currentAnswer = num1 * num2; num1El.textContent = num1; num2El.textContent = num2; progressTextEl.textContent = `문제 ${appState.currentProblemIndex + 1} / ${appState.problemsPerStage}`; answerInputEl.value = ''; answerInputEl.focus(); }
        function startStage(stageIndex) { appState.currentStage = stageIndex; appState.currentProblemIndex = 0; stageSelectionEl.style.display = 'none'; quizAreaEl.style.display = 'block'; quizAreaEl.classList.add('fade-in'); stageTitleEl.textContent = stages[stageIndex].name; newProblem(); }
        function checkAnswer() { const userAnswer = parseInt(answerInputEl.value); feedbackEl.classList.remove('pop-in', 'shake', 'text-green-600', 'text-red-500'); void feedbackEl.offsetWidth; if (userAnswer === appState.currentAnswer) { feedbackEl.textContent = '정답! 참 잘했어요! 🎉'; feedbackEl.className += ' pop-in text-green-600'; setTimeout(() => { appState.currentProblemIndex++; if (appState.currentProblemIndex >= appState.problemsPerStage) { completeStage(); } else { feedbackEl.textContent = ''; newProblem(); } }, 1500); } else { feedbackEl.textContent = '아쉬워요, 다시 풀어봐요! 🤔'; feedbackEl.className += ' shake text-red-500'; } }
        function completeStage() { if (appState.currentStage === appState.unlockedStage) { appState.unlockedStage++; } if (appState.unlockedStage >= stages.length) { showFinalCelebration(); } else { quizAreaEl.style.display = 'none'; stageSelectionEl.style.display = 'flex'; renderStageButtons(); } }

        function showFinalCelebration() {
            quizAreaEl.style.display = 'none';
            stageSelectionEl.style.display = 'none';
            document.querySelector('header').style.display = 'none';
            
            finalCelebrationEl.classList.remove('hidden');
            launchFireworks();
        }

        function launchFireworks() {
            const fireworkCount = 20;
            for (let i = 0; i < fireworkCount; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = `${Math.random() * 100}%`;
                firework.style.animationDelay = `${Math.random() * 2}s`;
                fireworksContainerEl.appendChild(firework);
            }
        }

        submitBtnEl.addEventListener('click', checkAnswer);
        answerInputEl.addEventListener('keyup', (event) => { if (event.key === 'Enter') { checkAnswer(); } });
        function init() { renderStageButtons(); }
        init();
    </script>
</body>
</html>